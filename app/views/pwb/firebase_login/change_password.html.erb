<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card shadow-sm mt-5">
        <div class="card-body p-4">
          <h3 class="text-center mb-4">Change Password</h3>
          
          <div id="change-form">
            <p class="text-muted">Enter your current password and choose a new one.</p>
            
            <div class="form-group mb-3">
              <label for="current-password">Current Password</label>
              <input type="password" class="form-control" id="current-password" placeholder="Enter current password" required>
            </div>
            
            <div class="form-group mb-3">
              <label for="new-password">New Password</label>
              <input type="password" class="form-control" id="new-password" placeholder="Enter new password (min 6 characters)" required>
            </div>
            
            <div class="form-group mb-3">
              <label for="confirm-password">Confirm New Password</label>
              <input type="password" class="form-control" id="confirm-password" placeholder="Confirm new password" required>
            </div>
            
            <button id="change-button" class="btn btn-primary w-100">Change Password</button>
            
            <div id="message" class="mt-3"></div>
          </div>
          
          <div class="text-center mt-3">
            <%= link_to "Back to Admin", "/admin", class: "text-decoration-none" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "<%= ENV['FIREBASE_API_KEY'] %>",
    authDomain: "<%= ENV['FIREBASE_PROJECT_ID'] %>.firebaseapp.com",
    projectId: "<%= ENV['FIREBASE_PROJECT_ID'] %>",
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  document.getElementById('change-button').addEventListener('click', function() {
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const messageDiv = document.getElementById('message');
    const button = document.getElementById('change-button');
    
    // Validation
    if (!currentPassword || !newPassword || !confirmPassword) {
      messageDiv.innerHTML = '<div class="alert alert-danger">Please fill in all fields.</div>';
      return;
    }
    
    if (newPassword !== confirmPassword) {
      messageDiv.innerHTML = '<div class="alert alert-danger">New passwords do not match.</div>';
      return;
    }
    
    if (newPassword.length < 6) {
      messageDiv.innerHTML = '<div class="alert alert-danger">Password must be at least 6 characters long.</div>';
      return;
    }
    
    if (currentPassword === newPassword) {
      messageDiv.innerHTML = '<div class="alert alert-danger">New password must be different from current password.</div>';
      return;
    }
    
    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = 'Changing...';
    messageDiv.innerHTML = '';
    
    const user = auth.currentUser;
    
    if (!user) {
      messageDiv.innerHTML = '<div class="alert alert-danger">You must be logged in to change your password.</div>';
      button.innerHTML = 'Change Password';
      button.disabled = false;
      return;
    }
    
    // Re-authenticate user before changing password
    const credential = firebase.auth.EmailAuthProvider.credential(
      user.email,
      currentPassword
    );
    
    user.reauthenticateWithCredential(credential)
      .then(function() {
        // Update password
        return user.updatePassword(newPassword);
      })
      .then(function() {
        messageDiv.innerHTML = '<div class="alert alert-success">Password changed successfully! You can now use your new password to log in.</div>';
        // Clear form
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        button.innerHTML = 'Change Password';
        button.disabled = false;
      })
      .catch(function(error) {
        let errorMessage = 'An error occurred. Please try again.';
        
        switch(error.code) {
          case 'auth/wrong-password':
            errorMessage = 'Current password is incorrect.';
            break;
          case 'auth/weak-password':
            errorMessage = 'Password is too weak. Please choose a stronger password.';
            break;
          case 'auth/requires-recent-login':
            errorMessage = 'Please log out and log in again before changing your password.';
            break;
          default:
            errorMessage = error.message;
        }
        
        messageDiv.innerHTML = '<div class="alert alert-danger">' + errorMessage + '</div>';
        button.innerHTML = 'Change Password';
        button.disabled = false;
      });
  });
</script>
