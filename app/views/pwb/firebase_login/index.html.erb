<h2 class="text-2xl font-bold text-gray-900 text-center mb-8">
  Admin Login
</h2>

<div id="firebaseui-auth-container"></div>
<div id="loader" class="text-center text-gray-500 py-4">
  <svg class="animate-spin h-6 w-6 mx-auto text-blue-600" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
  </svg>
  <span class="mt-2 block text-sm">Loading...</span>
</div>

<div class="mt-6 text-center space-y-2">
  <%= link_to "Forgot Password?", "/pwb_forgot_password",
      class: "text-sm font-medium text-blue-600 hover:text-blue-500" %>
  <p class="text-sm text-gray-600">
    Don't have an account?
    <%= link_to "Sign Up", "/pwb_sign_up",
        class: "font-medium text-blue-600 hover:text-blue-500" %>
  </p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
<link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />

<%# Override FirebaseUI styles to match Tailwind design %>
<style>
  /* Remove the card border/shadow from FirebaseUI */
  .firebaseui-container { max-width: 100% !important; }
  .firebaseui-card-content { padding: 0 !important; }
  .firebaseui-card-header { display: none !important; }
  .firebaseui-card-actions { padding: 0 !important; }
  .mdl-card { box-shadow: none !important; border: none !important; background: transparent !important; }
  .firebaseui-card-footer { display: none !important; }

  /* Button styling */
  .mdl-button--raised.mdl-button--colored {
    background-color: #2563eb !important;
    border-radius: 0.375rem !important;
    font-weight: 500 !important;
    text-transform: none !important;
    font-size: 0.875rem !important;
    padding: 0.5rem 1rem !important;
    height: auto !important;
    min-height: 2.5rem !important;
  }
  .mdl-button--raised.mdl-button--colored:hover { background-color: #1d4ed8 !important; }

  /* Input field styling */
  .firebaseui-input, .firebaseui-input-invalid {
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
    padding: 0.5rem 0.75rem !important;
    font-size: 0.875rem !important;
  }
  .firebaseui-input:focus { border-color: #3b82f6 !important; outline: none !important; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important; }
  .firebaseui-label { font-size: 0.875rem !important; color: #374151 !important; font-weight: 500 !important; }
  .firebaseui-textfield { margin-bottom: 1rem !important; }

  /* Form layout */
  .firebaseui-form-actions { margin-top: 1.5rem !important; }
  .firebaseui-id-submit { width: 100% !important; }
  .firebaseui-idp-list { margin: 0 !important; }
  .firebaseui-list-item { margin-bottom: 0.75rem !important; }
</style>

<script>
  // Return URL for redirect after login
  const returnUrl = '<%= j(@return_url || "/admin") %>';

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "<%= ENV['FIREBASE_API_KEY'] %>",
    authDomain: "<%= ENV['FIREBASE_PROJECT_ID'] %>.firebaseapp.com",
    projectId: "<%= ENV['FIREBASE_PROJECT_ID'] %>",
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  // Initialize the FirebaseUI Widget using Firebase.
  const ui = new firebaseui.auth.AuthUI(firebase.auth());

  const uiConfig = {
    callbacks: {
      signInSuccessWithAuthResult: function(authResult, redirectUrl) {
        // User successfully signed in.
        authResult.user.getIdToken().then(function(accessToken) {
          // Send token to backend
          fetch('/api_public/v1/auth/firebase', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ token: accessToken })
          })
          .then(response => {
            if (response.ok) {
              window.location.assign(returnUrl);
            } else {
              alert('Login failed on server side.');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred during login.');
          });
        });
        return false;
      },
      uiShown: function() {
        // Hide the loader when FirebaseUI is rendered
        document.getElementById('loader').style.display = 'none';
      }
    },
    signInFlow: 'popup',
    signInOptions: [
      {
        provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
        requireDisplayName: false,
        disableSignUp: { status: false }
      }
      // Google sign-in disabled - uncomment below to enable:
      // firebase.auth.GoogleAuthProvider.PROVIDER_ID
    ],
    credentialHelper: firebaseui.auth.CredentialHelper.NONE
  };

  // The start method will wait until the DOM is loaded.
  ui.start('#firebaseui-auth-container', uiConfig);
</script>
