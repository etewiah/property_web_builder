<div class="max-w-7xl mx-auto">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Platform Notifications</h1>
    <p class="mt-2 text-base text-gray-600">
      Manage ntfy push notifications and view platform metrics
    </p>
  </div>

  <!-- Configuration Status -->
  <div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">üì° Configuration Status</h2>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Status -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <span class="text-sm font-medium text-gray-700">Platform ntfy Enabled</span>
          <% if @config_status[:enabled] %>
            <span class="px-3 py-1 text-sm font-semibold text-green-800 bg-green-100 rounded-full">‚úÖ Enabled</span>
          <% else %>
            <span class="px-3 py-1 text-sm font-semibold text-red-800 bg-red-100 rounded-full">‚ùå Disabled</span>
          <% end %>
        </div>

        <!-- Server -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <span class="text-sm font-medium text-gray-700">Server URL</span>
          <code class="text-sm text-gray-900"><%= @config_status[:server_url] %></code>
        </div>

        <!-- Topic Prefix -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <span class="text-sm font-medium text-gray-700">Topic Prefix</span>
          <code class="text-sm text-gray-900"><%= @config_status[:topic_prefix] %></code>
        </div>

        <!-- Access Token -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <span class="text-sm font-medium text-gray-700">Access Token</span>
          <% if @config_status[:has_access_token] %>
            <span class="text-sm text-green-600">‚úì Configured</span>
          <% else %>
            <span class="text-sm text-gray-500">Not set (using public topics)</span>
          <% end %>
        </div>
      </div>

      <!-- Channels -->
      <div class="mt-6">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Notification Channels</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <% @config_status[:channels].each do |channel, enabled| %>
            <div class="flex items-center p-3 <%= enabled ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200' %> border rounded-lg">
              <span class="text-lg mr-2"><%= enabled ? '‚úÖ' : '‚ùå' %></span>
              <span class="text-sm font-medium text-gray-700"><%= channel.to_s.titleize %></span>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Topics to Subscribe -->
      <% if @config_status[:enabled] %>
        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <h3 class="text-sm font-semibold text-blue-900 mb-2">üì± Subscribe to these topics in your ntfy app:</h3>
          <div class="space-y-1">
            <% %w[signups provisioning subscriptions system test].each do |channel| %>
              <code class="block text-sm text-blue-800"><%= "#{@config_status[:topic_prefix]}-#{channel}" %></code>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Test Actions -->
  <div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">üß™ Test Notifications</h2>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Test Configuration -->
        <div class="p-4 border border-gray-200 rounded-lg">
          <h3 class="text-base font-semibold text-gray-900 mb-2">Test Configuration</h3>
          <p class="text-sm text-gray-600 mb-4">Send a test notification to verify your ntfy setup</p>
          <%= button_to 'Send Test Notification', 
              test_tenant_admin_platform_notifications_path, 
              method: :post,
              class: 'w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500',
              data: { turbo: false } %>
        </div>

        <!-- Daily Summary -->
        <div class="p-4 border border-gray-200 rounded-lg">
          <h3 class="text-base font-semibold text-gray-900 mb-2">Daily Summary</h3>
          <p class="text-sm text-gray-600 mb-4">Send today's metrics summary as a notification</p>
          <%= button_to 'Send Daily Summary', 
              send_daily_summary_tenant_admin_platform_notifications_path, 
              method: :post,
              class: 'w-full px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500',
              data: { turbo: false } %>
        </div>

        <!-- Custom Alert -->
        <div class="p-4 border border-gray-200 rounded-lg">
          <h3 class="text-base font-semibold text-gray-900 mb-2">Custom Alert</h3>
          <p class="text-sm text-gray-600 mb-4">Send a custom system alert notification</p>
          <button onclick="document.getElementById('customAlertModal').classList.remove('hidden')" 
                  class="w-full px-4 py-2 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
            Send Custom Alert
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Platform Metrics -->
  <div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">üìä Platform Metrics</h2>
    </div>
    <div class="p-6">
      <!-- Time Period Tabs -->
      <div class="mb-6 border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
          <button onclick="showMetricsPeriod('today')" id="tab-today" class="metrics-tab active border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600">
            Today
          </button>
          <button onclick="showMetricsPeriod('week')" id="tab-week" class="metrics-tab border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
            This Week
          </button>
          <button onclick="showMetricsPeriod('month')" id="tab-month" class="metrics-tab border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
            This Month
          </button>
          <button onclick="showMetricsPeriod('total')" id="tab-total" class="metrics-tab border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
            All Time
          </button>
        </nav>
      </div>

      <!-- Today Metrics -->
      <div id="metrics-today" class="metrics-period">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-blue-700">Signups</p>
            <p class="text-3xl font-bold text-blue-900 mt-2"><%= @metrics[:signups_today] %></p>
          </div>
          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-green-700">Websites Created</p>
            <p class="text-3xl font-bold text-green-900 mt-2"><%= @metrics[:websites_created_today] %></p>
          </div>
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-purple-700">Subscriptions Activated</p>
            <p class="text-3xl font-bold text-purple-900 mt-2"><%= @metrics[:subscriptions_activated_today] %></p>
          </div>
          <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-red-700">Subscriptions Canceled</p>
            <p class="text-3xl font-bold text-red-900 mt-2"><%= @metrics[:subscriptions_canceled_today] %></p>
          </div>
        </div>
      </div>

      <!-- This Week Metrics -->
      <div id="metrics-week" class="metrics-period hidden">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-blue-700">Signups</p>
            <p class="text-3xl font-bold text-blue-900 mt-2"><%= @metrics[:signups_this_week] %></p>
          </div>
          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-green-700">Websites Created</p>
            <p class="text-3xl font-bold text-green-900 mt-2"><%= @metrics[:websites_created_this_week] %></p>
          </div>
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-purple-700">Subscriptions Activated</p>
            <p class="text-3xl font-bold text-purple-900 mt-2"><%= @metrics[:subscriptions_activated_this_week] %></p>
          </div>
          <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-red-700">Subscriptions Canceled</p>
            <p class="text-3xl font-bold text-red-900 mt-2"><%= @metrics[:subscriptions_canceled_this_week] %></p>
          </div>
        </div>
      </div>

      <!-- This Month Metrics -->
      <div id="metrics-month" class="metrics-period hidden">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-blue-700">Signups</p>
            <p class="text-3xl font-bold text-blue-900 mt-2"><%= @metrics[:signups_this_month] %></p>
          </div>
          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-green-700">Websites Created</p>
            <p class="text-3xl font-bold text-green-900 mt-2"><%= @metrics[:websites_created_this_month] %></p>
          </div>
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-purple-700">Subscriptions Activated</p>
            <p class="text-3xl font-bold text-purple-900 mt-2"><%= @metrics[:subscriptions_activated_this_month] %></p>
          </div>
          <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-red-700">Subscriptions Canceled</p>
            <p class="text-3xl font-bold text-red-900 mt-2"><%= @metrics[:subscriptions_canceled_this_month] %></p>
          </div>
        </div>
      </div>

      <!-- All Time Metrics -->
      <div id="metrics-total" class="metrics-period hidden">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-blue-700">Total Users</p>
            <p class="text-3xl font-bold text-blue-900 mt-2"><%= @metrics[:total_users] %></p>
          </div>
          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-green-700">Active Websites</p>
            <p class="text-3xl font-bold text-green-900 mt-2"><%= @metrics[:total_active_websites] %></p>
          </div>
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-purple-700">Active Subscriptions</p>
            <p class="text-3xl font-bold text-purple-900 mt-2"><%= @metrics[:total_active_subscriptions] %></p>
          </div>
          <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-lg">
            <p class="text-sm font-medium text-amber-700">Monthly Recurring Revenue</p>
            <p class="text-3xl font-bold text-amber-900 mt-2">$<%= number_with_precision(@metrics[:total_mrr_cents] / 100.0, precision: 0) %></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">üïê Recent Activity (Last 24 Hours)</h2>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Recent Signups -->
        <div>
          <h3 class="text-sm font-semibold text-gray-700 mb-3">Recent Signups</h3>
          <% if @metrics[:recent_signups].any? %>
            <ul class="space-y-2">
              <% @metrics[:recent_signups].each do |user| %>
                <li class="text-sm text-gray-600">
                  <%= user.email %><br>
                  <span class="text-xs text-gray-400"><%= time_ago_in_words(user.created_at) %> ago</span>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="text-sm text-gray-500">No recent signups</p>
          <% end %>
        </div>

        <!-- Recent Websites -->
        <div>
          <h3 class="text-sm font-semibold text-gray-700 mb-3">Recent Websites</h3>
          <% if @metrics[:recent_websites].any? %>
            <ul class="space-y-2">
              <% @metrics[:recent_websites].each do |website| %>
                <li class="text-sm text-gray-600">
                  <%= link_to website.subdomain, tenant_admin_website_path(website), class: "text-blue-600 hover:text-blue-800" %><br>
                  <span class="text-xs text-gray-400"><%= time_ago_in_words(website.created_at) %> ago</span>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="text-sm text-gray-500">No recent websites</p>
          <% end %>
        </div>

        <!-- Recent Subscriptions -->
        <div>
          <h3 class="text-sm font-semibold text-gray-700 mb-3">Recent Subscriptions</h3>
          <% if @metrics[:recent_subscriptions].any? %>
            <ul class="space-y-2">
              <% @metrics[:recent_subscriptions].each do |subscription| %>
                <li class="text-sm text-gray-600">
                  <%= subscription.website.subdomain %> - <%= subscription.plan.name %><br>
                  <span class="text-xs text-gray-400"><%= time_ago_in_words(subscription.created_at) %> ago</span>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="text-sm text-gray-500">No recent subscriptions</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Custom Alert Modal -->
<div id="customAlertModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Send Custom Alert</h3>
      <%= form_with url: send_test_alert_tenant_admin_platform_notifications_path, method: :post, data: { turbo: false } do |f| %>
        <div class="mb-4">
          <%= f.label :title, "Alert Title", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.text_field :title, value: "Test Alert", class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        
        <div class="mb-4">
          <%= f.label :message, "Message", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.text_area :message, value: "This is a test alert from the admin panel", rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <div class="mb-4">
          <%= f.label :priority, "Priority", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :priority, 
              options_for_select([
                ['Min (1)', 1],
                ['Low (2)', 2],
                ['Default (3)', 3],
                ['High (4)', 4],
                ['Urgent (5)', 5]
              ], 5),
              {},
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <div class="flex justify-end space-x-3">
          <button type="button" onclick="document.getElementById('customAlertModal').classList.add('hidden')" 
                  class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
            Cancel
          </button>
          <%= f.submit "Send Alert", class: "px-4 py-2 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-md" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
function showMetricsPeriod(period) {
  // Hide all periods
  document.querySelectorAll('.metrics-period').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.metrics-tab').forEach(el => {
    el.classList.remove('active', 'border-blue-500', 'text-blue-600');
    el.classList.add('border-transparent', 'text-gray-500');
  });

  // Show selected period
  document.getElementById(`metrics-${period}`).classList.remove('hidden');
  const tab = document.getElementById(`tab-${period}`);
  tab.classList.add('active', 'border-blue-500', 'text-blue-600');
  tab.classList.remove('border-transparent', 'text-gray-500');
}
</script>
