<%
  # Build palettes data for all themes (for dynamic switching)
  all_theme_palettes = @themes.each_with_object({}) do |theme, hash|
    hash[theme.name] = theme.palettes.transform_values do |p|
      {
        name: p['name'],
        description: p['description'],
        preview_colors: p['preview_colors'],
        colors: p['colors'],
        is_default: p['is_default']
      }
    end
  end
%>

<div class="p-6" data-controller="theme-palette"
     data-theme-palette-palettes-value="<%= all_theme_palettes.to_json %>"
     data-theme-palette-current-theme-value="<%= @website.theme_name %>">
  <h2 class="text-xl font-semibold text-gray-900 mb-6">Appearance Settings</h2>

  <%= form_with model: @website, url: site_admin_website_settings_path, method: :patch, local: true, class: "space-y-6" do |f| %>
    <input type="hidden" name="tab" value="appearance">

    <!-- Theme Selection -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-3">
        Theme
      </label>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <% @themes.each do |theme| %>
          <label class="relative cursor-pointer">
            <input type="radio" name="website[theme_name]" value="<%= theme.name %>"
                   <%= 'checked' if @website.theme_name == theme.name %>
                   class="sr-only peer"
                   data-theme-palette-target="themeRadio"
                   data-action="change->theme-palette#selectTheme">
            <div class="border-2 rounded-lg p-4 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-400 transition-colors">
              <div class="h-24 bg-gray-100 rounded mb-3 flex items-center justify-center">
                <span class="text-gray-400 text-sm"><%= theme.friendly_name %></span>
              </div>
              <div class="flex items-center justify-between">
                <span class="font-medium text-gray-900"><%= theme.friendly_name %></span>
                <span class="hidden peer-checked:inline-block text-blue-600">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                </span>
              </div>
            </div>
          </label>
        <% end %>
      </div>
    </div>

    <!-- Color Palette Selection -->
    <div class="border-t border-gray-200 pt-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Color Palette</h3>
      <p class="text-sm text-gray-600 mb-4">Choose a curated color palette for your theme. This will set harmonious colors for your entire site.</p>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" data-theme-palette-target="paletteContainer">
        <% if @website.current_theme&.palettes&.any? %>
          <% @website.current_theme.palettes.each do |palette_id, palette| %>
            <label class="relative cursor-pointer group">
              <input type="radio" name="website[selected_palette]" value="<%= palette_id %>"
                     <%= 'checked' if @website.effective_palette_id == palette_id %>
                     class="sr-only peer"
                     data-palette-colors="<%= palette['colors'].to_json %>">
              <div class="border-2 rounded-lg p-4 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-400 transition-all">
                <!-- Color Preview Swatches -->
                <div class="flex h-12 rounded-lg overflow-hidden mb-3 shadow-sm">
                  <% palette['preview_colors'].each_with_index do |color, i| %>
                    <div class="flex-1 <%= 'rounded-l-lg' if i == 0 %> <%= 'rounded-r-lg' if i == palette['preview_colors'].length - 1 %>"
                         style="background-color: <%= color %>"></div>
                  <% end %>
                </div>
                <div class="flex items-center justify-between">
                  <div>
                    <span class="font-medium text-gray-900 block"><%= palette['name'] %></span>
                    <span class="text-xs text-gray-500"><%= palette['description'] %></span>
                  </div>
                  <span class="hidden peer-checked:inline-block text-blue-600">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                  </span>
                </div>
              </div>
            </label>
          <% end %>
        <% else %>
          <p class="text-gray-500 col-span-full">No palettes available for this theme.</p>
        <% end %>
      </div>
    </div>

    <!-- Color Settings (Advanced) -->
    <div class="border-t border-gray-200 pt-6">
      <details class="group">
        <summary class="flex items-center justify-between cursor-pointer list-none">
          <h3 class="text-lg font-medium text-gray-900">Advanced Color Settings</h3>
          <span class="text-gray-500 group-open:rotate-180 transition-transform">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </span>
        </summary>
        <p class="text-sm text-gray-600 mt-2 mb-4">Override individual colors. Note: These settings override the selected palette.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
        <!-- Primary Color -->
        <div>
          <label for="primary_color" class="block text-sm font-medium text-gray-700 mb-1">
            Primary Color
          </label>
          <div class="flex items-center space-x-3">
            <input type="color" name="website[style_variables][primary_color]"
                   value="<%= @style_variables['primary_color'] || '#e91b23' %>"
                   class="h-10 w-16 rounded border border-gray-300 cursor-pointer">
            <input type="text" name="website[style_variables][primary_color]"
                   value="<%= @style_variables['primary_color'] || '#e91b23' %>"
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                   pattern="^#[0-9A-Fa-f]{6}$"
                   placeholder="#e91b23">
          </div>
          <p class="mt-1 text-sm text-gray-500">Main brand color</p>
        </div>

        <!-- Secondary Color -->
        <div>
          <label for="secondary_color" class="block text-sm font-medium text-gray-700 mb-1">
            Secondary Color
          </label>
          <div class="flex items-center space-x-3">
            <input type="color" name="website[style_variables][secondary_color]"
                   value="<%= @style_variables['secondary_color'] || '#3498db' %>"
                   class="h-10 w-16 rounded border border-gray-300 cursor-pointer">
            <input type="text" name="website[style_variables][secondary_color]"
                   value="<%= @style_variables['secondary_color'] || '#3498db' %>"
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                   pattern="^#[0-9A-Fa-f]{6}$"
                   placeholder="#3498db">
          </div>
          <p class="mt-1 text-sm text-gray-500">Accent color for highlights</p>
        </div>

        <!-- Action Color -->
        <div>
          <label for="action_color" class="block text-sm font-medium text-gray-700 mb-1">
            Action Color
          </label>
          <div class="flex items-center space-x-3">
            <input type="color" name="website[style_variables][action_color]"
                   value="<%= @style_variables['action_color']&.start_with?('#') ? @style_variables['action_color'] : '#22c55e' %>"
                   class="h-10 w-16 rounded border border-gray-300 cursor-pointer">
            <input type="text" name="website[style_variables][action_color]"
                   value="<%= @style_variables['action_color'] || 'green' %>"
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                   placeholder="green or #22c55e">
          </div>
          <p class="mt-1 text-sm text-gray-500">Color for buttons and CTAs</p>
        </div>
      </div>
      </details>
    </div>

    <!-- Custom CSS -->
    <div class="border-t border-gray-200 pt-6">
      <label for="raw_css" class="block text-sm font-medium text-gray-700 mb-1">
        Custom CSS
      </label>
      <%= f.text_area :raw_css,
          rows: 10,
          class: "w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
          placeholder: "/* Add your custom CSS here */\n.my-class {\n  color: #333;\n}" %>
      <p class="mt-1 text-sm text-gray-500">Add custom CSS to override theme styles. Changes apply site-wide.</p>
    </div>

    <!-- Submit Button -->
    <div class="pt-4 border-t border-gray-200">
      <%= f.submit "Save Appearance Settings",
          class: "px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 cursor-pointer" %>
    </div>
  <% end %>
</div>

<script>
  // Sync color picker with text input
  document.querySelectorAll('input[type="color"]').forEach(colorInput => {
    const textInput = colorInput.nextElementSibling;

    colorInput.addEventListener('input', function() {
      textInput.value = this.value;
    });

    textInput.addEventListener('input', function() {
      if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
        colorInput.value = this.value;
      }
    });
  });
</script>
