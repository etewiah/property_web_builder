<!DOCTYPE html>
<html lang="<%= I18n.locale %>">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index, follow">
    <title><%= yield(:page_title) %></title>
    <%= favicon_tags %>
    <%= yield(:page_head) %>

    <%# DNS Prefetch for external resources %>
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//unpkg.com">
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">

    <%# Preconnect for faster font loading %>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <%# Critical CSS - loaded synchronously %>
    <%= stylesheet_link_tag "tailwind-bologna", media: "all" %>
    <%= stylesheet_link_tag "bologna_theme", media: "all" %>
    <style>
      <%= custom_styles "bologna" %>
    </style>

    <%# Google Fonts - async loading with swap for better LCP %>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Outfit:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet"></noscript>

    <%# Flowbite CSS - deferred (only needed for interactive components) %>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet"></noscript>

    <%# Leaflet CSS - deferred (only needed on map pages) %>
    <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style" onload="this.onload=null;this.rel='stylesheet'" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    <noscript><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""></noscript>

    <%# Font Awesome - deferred %>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" crossorigin="anonymous">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous"></noscript>

    <%# Deferred JavaScript for better page speed %>
    <%= javascript_include_tag "pwb/application", defer: true %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js" defer></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" defer></script>
    <script src="https://unpkg.com/@phosphor-icons/web" defer></script>
    <%= csrf_meta_tags %>
  </head>

  <body class="tnt-body bologna-theme <%= @current_website.body_style %> font-sans antialiased bg-warm-gray-50 text-warm-gray-900">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 focus:z-50 focus:p-4 focus:bg-white focus:text-terra-600">Skip to main content</a>

    <%# MAIN WRAPPER %>
    <div id="main-vue" class="body-wrap sticky-wrap <%= @current_website.body_style %> flex flex-col min-h-screen">

      <%# Minimal Header %>
      <%= render partial: '/pwb/header', locals: { not_devise: true } %>

      <%# Main Content %>
      <main id="main-content" class="sticky-body flex-grow" role="main">
        <%= render 'devise/shared/messages' %>
        <%= yield %>
      </main>

      <%# Modern Footer %>
      <%= render partial: '/pwb/footer', locals: {} %>

      <%# Back to Top Button %>
      <button id="back-to-top"
              aria-label="Back to top"
              class="fixed bottom-8 right-8 z-50 w-12 h-12 bg-terra-500 text-white rounded-full shadow-medium
                     opacity-0 invisible transition-all duration-300 hover:bg-terra-600 hover:shadow-elevated
                     flex items-center justify-center">
        <i class="ph ph-caret-up text-xl" aria-hidden="true"></i>
      </button>

      <%# Analytics %>
      <%= render partial: '/pwb/analytics', locals: {} %>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Sticky header with backdrop blur
        const header = document.querySelector('header, nav');
        if (header) {
          window.addEventListener('scroll', function() {
            if (window.scrollY > 20) {
              header.classList.add('bg-white/95', 'backdrop-blur-md', 'shadow-soft');
            } else {
              header.classList.remove('bg-white/95', 'backdrop-blur-md', 'shadow-soft');
            }
          });
        }

        // Mobile menu toggle
        const menuButton = document.querySelector('[data-collapse-toggle="navbar-main"]');
        const menu = document.getElementById('navbar-main');

        if (menuButton && menu) {
          menuButton.addEventListener('click', function() {
            menu.classList.toggle('hidden');
            menu.classList.toggle('animate-slide-in');
          });
        }

        // User dropdown toggle
        const dropdownButton = document.querySelector('[data-dropdown-toggle="user-dropdown"]');
        const dropdown = document.getElementById('user-dropdown');

        if (dropdownButton && dropdown) {
          dropdownButton.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdown.classList.toggle('hidden');
          });

          document.addEventListener('click', function() {
            if (!dropdown.classList.contains('hidden')) {
              dropdown.classList.add('hidden');
            }
          });
        }

        // Back to top button
        const backToTop = document.getElementById('back-to-top');
        if (backToTop) {
          window.addEventListener('scroll', function() {
            if (window.scrollY > 400) {
              backToTop.classList.remove('opacity-0', 'invisible');
              backToTop.classList.add('opacity-100', 'visible');
            } else {
              backToTop.classList.add('opacity-0', 'invisible');
              backToTop.classList.remove('opacity-100', 'visible');
            }
          });

          backToTop.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
        }

        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
          anchor.addEventListener('click', function (e) {
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
              e.preventDefault();
              target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
              });
            }
          });
        });

        // Animate elements on scroll with Intersection Observer
        const observerOptions = {
          threshold: 0.1,
          rootMargin: '0px 0px -60px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.style.opacity = '1';
              entry.target.style.transform = 'translateY(0)';
              observer.unobserve(entry.target);
            }
          });
        }, observerOptions);

        document.querySelectorAll('.animate-on-scroll').forEach(el => {
          el.style.opacity = '0';
          el.style.transform = 'translateY(20px)';
          el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
          observer.observe(el);
        });

        // Card hover effects
        document.querySelectorAll('.card-hover').forEach(card => {
          card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-4px)';
          });
          card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
          });
        });
      });
    </script>

    <%= yield(:page_script) %>

    <% if params[:edit_mode] == 'true' %>
      <%= javascript_include_tag "pwb/editor_client" %>
    <% end %>
  </body>
</html>
